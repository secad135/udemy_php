# جزوه: بررسی امنیت در Query String و جلوگیری از SQL Injection در PHP

در این جلسه یاد می‌گیریم چگونه مقدار `id` را از Query String دریافت کنیم، آن را در SQL استفاده کنیم، و مهم‌تر از آن — چگونه از حمله‌ی **SQL Injection** جلوگیری کنیم.

---

## 💡 مفهوم Query String

در فایل `index.php`، لینک هر مقاله به صورت زیر ساخته می‌شود:

```php
<a href="article.php?id=<?= $article['id']; ?>">
```

با این کار، وقتی روی عنوان مقاله کلیک می‌کنیم، مقدار `id` به آدرس صفحه اضافه می‌شود، مثلاً:

```
article.php?id=3
```

در صفحه‌ی `article.php`، مقدار `id` با استفاده از سوپر‌گلوبال `$_GET` دریافت می‌شود:

```php
$_GET['id']
```

---

## ⚠️ خطر SQL Injection

در حالت اولیه، کد ممکن است به شکل زیر باشد:

```php
$sql = "SELECT * FROM article WHERE id = " . $_GET['id'];
```

اگر کاربر مقدار `id` را در آدرس به صورت `id=3 OR 1=1` تغییر دهد، کوئری خطرناکی ایجاد می‌شود که می‌تواند باعث نمایش داده‌های غیرمجاز شود. به این نوع حمله، **SQL Injection** گفته می‌شود.

> ⚠️ با این روش، کاربر می‌تواند دستورات SQL دلخواه خود را روی پایگاه داده اجرا کند.

منبع: [SQL Injection - PHP Manual](https://www.php.net/manual/en/security.database.sql-injection.php)

---

## 🧰 راه‌حل ساده: بررسی مقدار عددی بودن

برای جلوگیری از تزریق SQL، اولین قدم بررسی عددی بودن مقدار `id` است:

```php
if (isset($_GET['id']) && is_numeric($_GET['id'])) {
    $sql = "SELECT * FROM article WHERE id = " . $_GET['id'];
    $results = mysqli_query($conn, $sql);

    if ($results === false) {
        echo mysqli_error($conn);
    } else {
        $article = mysqli_fetch_assoc($results);
    }
} else {
    $article = null;
}
```

### توضیح توابع:

* [`isset()`](https://www.php.net/manual/en/function.isset.php): بررسی می‌کند آیا متغیر تعریف شده است یا نه.
* [`is_numeric()`](https://www.php.net/manual/en/function.is-numeric.php): بررسی می‌کند آیا مقدار عددی است یا خیر.

به این ترتیب اگر کسی `id=test` یا `id='DROP TABLE'` وارد کند، کوئری اجرا نمی‌شود.

---

## 🧠 نکته امنیتی مهم

حتی با این روش هم ایمنی کامل نداریم. بهترین روش استفاده از **Prepared Statements** است که در جلسات بعدی آموزش داده می‌شود.

اما برای الان، بررسی `isset()` و `is_numeric()` مانع خطاهای ناخواسته و نمایش پیغام‌های خطرناک به کاربر می‌شود.

---

## 🧱 نمایش خطاها در محیط توسعه و تولید

در محیط توسعه، دیدن خطاها مفید است، اما در سایت‌های واقعی (Production) باید از نمایش پیام‌های خطا جلوگیری کرد تا اطلاعات ساختار پایگاه داده لو نرود:

```php
ini_set('display_errors', 0);
```

---

## ✅ نتیجه‌گیری

| هدف                             | روش ایمن‌سازی                                         |
| ------------------------------- | ----------------------------------------------------- |
| جلوگیری از تزریق SQL            | بررسی `is_numeric()` و استفاده از Prepared Statements |
| جلوگیری از خطای Undefined Index | بررسی `isset()`                                       |
| پنهان‌سازی خطاها در سرور واقعی  | غیرفعال کردن نمایش خطاها                              |

---

### 🔗 منابع رسمی PHP

* [is_numeric() - PHP Manual](https://www.php.net/manual/en/function.is-numeric.php)
* [isset() - PHP Manual](https://www.php.net/manual/en/function.isset.php)
* [Logical Operators - PHP Manual](https://www.php.net/manual/en/language.operators.logical.php)

---

### 📄 نمونه نهایی فایل `article.php`

```php
<?php

$db_host = "localhost";
$db_name = "cms";
$db_user = "cms_www";
$db_pass = "64w6H2rOJ1zwLRyk";

$conn = mysqli_connect($db_host, $db_user, $db_pass, $db_name);

if (mysqli_connect_error()) {
    echo mysqli_connect_error();
    exit;
}

if (isset($_GET['id']) && is_numeric($_GET['id'])) {

    $sql = "SELECT * FROM article WHERE id = " . $_GET['id'];
    $results = mysqli_query($conn, $sql);

    if ($results === false) {
        echo mysqli_error($conn);
    } else {
        $article = mysqli_fetch_assoc($results);
    }

} else {
    $article = null;
}
?>
<!DOCTYPE html>
<html>
<head>
    <title>My blog</title>
    <meta charset="utf-8">
</head>
<body>

<header>
    <h1>My blog</h1>
</header>

<main>
    <?php if ($article === null): ?>
        <p>Article not found.</p>
    <?php else: ?>
        <article>
            <h2><?= $article['title']; ?></h2>
            <p><?= $article['content']; ?></p>
        </article>
    <?php endif; ?>
</main>

</body>
</html>
```

---

✅ با این تغییرات، اگر کاربر `id` را حذف یا دستکاری کند، پیغام خطای مناسب نمایش داده می‌شود و هیچ اطلاعات حساسی لو نمی‌رود.
