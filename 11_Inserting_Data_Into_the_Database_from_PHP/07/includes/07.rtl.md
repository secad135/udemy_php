# جزوه: جلوگیری از SQL Injection با استفاده از Prepared Statements در PHP

## مفهوم Prepared Statement

روش دوم برای جلوگیری از **SQL Injection**، استفاده از **Prepared Statement** است.

در این روش ابتدا یک **دستور SQL** می‌نویسیم که شامل **جای‌نگهدارها (Placeholders)** است. سپس مقادیر را به‌صورت امن به این جای‌نگهدارها **Bind** یا متصل می‌کنیم.

در این حالت، سرور دیتابیس خودش داده‌ها را به‌صورت ایمن در دستور SQL قرار می‌دهد و امکان حمله‌ی SQL Injection از بین می‌رود.

---

## مراحل استفاده از Prepared Statement

1. **نوشتن دستور SQL با جای‌نگهدارها**
   به‌جای قرار دادن مستقیم داده‌های فرم در رشته‌ی SQL، از علامت سؤال `?` به عنوان جای‌نگهدار استفاده می‌کنیم:

   ```php
   $sql = "INSERT INTO article (title, content, published_at) VALUES (?, ?, ?)";
   ```

2. **آماده‌سازی (Prepare)**
   به‌جای اجرای مستقیم SQL، ابتدا آن را با تابع `mysqli_prepare()` آماده می‌کنیم:

   ```php
   $stmt = mysqli_prepare($conn, $sql);
   ```

   اگر مقدار برگشتی `false` باشد، یعنی در SQL خطایی وجود دارد.

3. **اتصال مقادیر (Bind)**
   با استفاده از تابع `mysqli_stmt_bind_param()` مقادیر فرم را به جای‌نگهدارها متصل می‌کنیم:

   ```php
   mysqli_stmt_bind_param($stmt, "sss", $_POST['title'], $_POST['content'], $_POST['published_at']);
   ```

   در این تابع:

   * `"s"` یعنی مقدار از نوع **string** است.
   * اگر عدد صحیح بود از `"i"` استفاده می‌کنیم.
   * به ازای هر مقدار، یک کاراکتر نوع قرار می‌دهیم.

4. **اجرا (Execute)**
   سپس دستور آماده‌شده را با تابع `mysqli_stmt_execute()` اجرا می‌کنیم:

   ```php
   mysqli_stmt_execute($stmt);
   ```

   در این مرحله، سرور دیتابیس خودش مقادیر را در SQL درج می‌کند و در صورت نیاز کوتیشن‌ها را **escape** می‌نماید.

5. **بررسی نتیجه و گرفتن ID درج‌شده**
   اگر اجرای دستور موفقیت‌آمیز بود:

   ```php
   $id = mysqli_insert_id($conn);
   echo "Inserted record with ID: $id";
   ```

   در غیر این صورت می‌توان خطا را چاپ کرد:

   ```php
   echo mysqli_stmt_error($stmt);
   ```

---

## نکات مهم

* هنگام استفاده از Prepared Statement نمی‌توان رشته‌ی کامل SQL نهایی را در PHP مشاهده کرد، زیرا جایگزینی مقادیر در سمت **سرور دیتابیس** انجام می‌شود.
* اگر بخواهید SQLهای اجراشده را ببینید، باید **Query Log** را در سرور دیتابیس فعال کنید (توضیحات در مستندات سرور موجود است).
* هر زمان که داده‌ها از منابع غیرقابل اعتماد (مثل فرم کاربر) گرفته می‌شود، باید **یا از تابع escape استفاده کنید** یا **از Prepared Statement بهره ببرید**، در غیر این صورت کد شما در برابر SQL Injection آسیب‌پذیر خواهد بود.

---

## کد نمونه کامل

```php
<?php

if ($_SERVER["REQUEST_METHOD"] == "POST") {

    require 'includes/database.php';

    $sql = "INSERT INTO article (title, content, published_at)
            VALUES (?, ?, ?)";

    $stmt = mysqli_prepare($conn, $sql);

    if ($stmt === false) {
        echo mysqli_error($conn);
    } else {
        mysqli_stmt_bind_param($stmt, "sss", $_POST['title'], $_POST['content'], $_POST['published_at']);

        if (mysqli_stmt_execute($stmt)) {
            $id = mysqli_insert_id($conn);
            echo "Inserted record with ID: $id";
        } else {
            echo mysqli_stmt_error($stmt);
        }
    }
}

?>
<?php require 'includes/header.php'; ?>

<h2>New article</h2>

<form method="post">

    <div>
        <label for="title">Title</label>
        <input name="title" id="title" placeholder="Article title">
    </div>

    <div>
        <label for="content">Content</label>
        <textarea name="content" rows="4" cols="40" id="content" placeholder="Article content"></textarea>
    </div>

    <div>
        <label for="published_at">Publication date and time</label>
        <input type="datetime-local" name="published_at" id="published_at">
    </div>

    <button>Add</button>

</form>

<?php require 'includes/footer.php'; ?>
```
