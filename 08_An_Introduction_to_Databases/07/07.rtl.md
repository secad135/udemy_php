# جزوه آموزش اجرای کوئری SQL در PHP

## مقدمه

بعد از اتصال موفق به پایگاه داده از طریق PHP، می‌توانیم داده‌ها را از آن دریافت کنیم.

## مراحل اصلی اجرای کوئری در PHP

### 1. تعریف کوئری SQL

یک متغیر برای ذخیره کوئری SQL ایجاد می‌کنیم:

```php
$sql = "SELECT *
        FROM article
        ORDER BY published_at;";
```

* استفاده از چند خط برای خوانایی بهتر امکان‌پذیر است.
* سمی‌کالن در انتهای کوئری در PHP اختیاری است.

### 2. ارسال کوئری به پایگاه داده

از تابع `mysqli_query` استفاده می‌کنیم:

```php
$results = mysqli_query($conn, $sql);
```

* این تابع نتیجه را باز می‌گرداند یا در صورت خطا مقدار Boolean `false`.

### 3. بررسی خطا

برای بررسی خطاها بهتر است از مقایسه دقیق (`=== false`) استفاده کنیم:

```php
if ($results === false) {
    echo mysqli_error($conn);
} else {
    $articles = mysqli_fetch_all($results, MYSQLI_ASSOC);
    var_dump($articles);
}
```

* مقایسه با `===` باعث می‌شود فقط مقدار false واقعی تشخیص داده شود و اشتباهاً مقادیر دیگری مانند رشته خالی یا آرایه خالی به عنوان false در نظر گرفته نشود.
* تابع `mysqli_error` متن خطا را برمی‌گرداند.

### 4. دریافت نتایج

* می‌توانیم نتایج را یک به یک با `mysqli_fetch_row` دریافت کنیم.
* یا به صورت یکجا با `mysqli_fetch_all` و آرایه انجمنی (associative array) دریافت کنیم.

```php
$articles = mysqli_fetch_all($results, MYSQLI_ASSOC);
```

* این کار کد را تمیزتر می‌کند و جدا بودن بخش دریافت داده از نمایش آن را حفظ می‌کند.

### 5. نمایش داده‌ها

می‌توانیم داده‌ها را با `var_dump` یا متدهای دیگر نمایش دهیم.

* آرایه ایجاد شده شامل رکوردهای پایگاه داده است.
* استفاده از `MYSQLI_ASSOC` باعث می‌شود اندیس‌ها با نام ستون‌ها مطابق باشند.

### 6. مدیریت خطاهای SQL

* اگر کوئری اشتباه باشد، پیام خطا کمک می‌کند مشکل را شناسایی کنیم.
* مثال‌ها:

  * خطای سینتکس در SQL
  * وجود نداشتن جدول مورد نظر

## کد کامل نمونه

```php
<?php
$db_host = "localhost";
$db_name = "cms";
$db_user = "cms_www";
$db_pass = "64w6H2rOJ1zwLRyk";

$conn = mysqli_connect($db_host, $db_user, $db_pass, $db_name);

if (mysqli_connect_error()) {
    echo mysqli_connect_error();
    exit;
}

$sql = "SELECT *
        FROM article
        ORDER BY published_at;";

$results = mysqli_query($conn, $sql);

if ($results === false) {
    echo mysqli_error($conn);
} else {
    $articles = mysqli_fetch_all($results, MYSQLI_ASSOC);
    var_dump($articles);
}
?>
```

## منابع آموزشی

* [mysqli_query](https://www.php.net/manual/en/mysqli.query.php)
* [Boolean Casting](https://www.php.net/manual/en/language.types.boolean.php#language.types.boolean.casting)
* [Comparison Operators](https://www.php.net/manual/en/language.operators.comparison.php)
* [mysqli_fetch_row](https://www.php.net/manual/en/mysqli-result.fetch-row.php)
* [mysqli_fetch_all](https://www.php.net/manual/en/mysqli-result.fetch-all.php)
